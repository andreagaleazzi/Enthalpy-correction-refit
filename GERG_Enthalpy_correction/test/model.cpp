#include "main.h"

double model(const input_vector& input, const parameter_vector& params)
{
	double DHr[2] = { 0., 0. };


#if MIXTURE_COMPS == 1
	const double a[5][3] =
	{
		{params(0), params(0), params(0)},
		{params(1), params(1), params(1)},
		{params(2), params(2), params(2)},
		{params(3), params(3), params(3)},
		{params(4), params(4), params(4)}
	};
	const double c[5][3] =
	{
		{params(5), params(5), params(5)},
		{params(6), params(6), params(6)},
		{params(7), params(7), params(7)},
		{params(8), params(8), params(8)},
		{params(9), params(9), params(9)}
	};
#elif MIXTURE_COMPS == 2
#if PHASE == 0
	const double a[5][9] =
	{
		{ -2.112335199397250918e+01, -2.122296384713962780e+01, -2.829967280774834748e+01, params(0), params(0), params(0), params(10), params(10), params(10) },
		{ +1.046396618389127582e+02, +1.059785121920906477e+02, +1.260472794252481208e+02, params(1), params(1), params(1), params(11), params(11), params(11) },
		{ -1.599224337848212656e+02, -1.819807981679254567e+02, -2.084168293425671550e+02, params(2), params(2), params(2), params(12), params(12), params(12) },
		{ +8.664634611819901977e+01, +1.237434617839810613e+02, +1.458238757695254151e+02, params(3), params(3), params(3), params(13), params(13), params(13) },
		{ -1.542022369101818136e+01, -2.739369045135615011e+01, -3.585723434866019232e+01, params(4), params(4), params(4), params(14), params(14), params(14) }
	};
	const double c[5][9] =
	{
		{ +1.014050096628394959e-01, -2.542739287223894640e-01, -1.717154048277529377e-01, params(5), params(5), params(5), params(15), params(15), params(15) },
		{ +4.503818080797233847e+01, +9.355105225779826128e+01, +5.732789284514770856e+01, params(6), params(6), params(6), params(16), params(16), params(16) },
		{ -1.150004970895609375e+02, -6.855041029558282162e+01, +1.810478643057546151e+02, params(7), params(7), params(7), params(17), params(17), params(17) },
		{ +1.655638213007880211e+02, +1.885677302674298232e+02, -2.342503542711407931e+02, params(8), params(8), params(8), params(18), params(18), params(18) },
		{ -9.416721557588948599e+01, -1.781190705369886587e+02, +1.290861652223049703e+02, params(9), params(9), params(9), params(19), params(19), params(19) }
	};
#elif PHASE == 1
	const double a[5][9] =
	{
		{ +1.703440521331973798e+02, -7.186474267171755628e+02, -5.206671854231613139e+01, params(0), params(0), params(0), params(10), params(10), params(10) },
		{ -6.318017110160004677e+02, +2.107224065718693055e+03, +1.132924212617995181e+02, params(1), params(1), params(1), params(11), params(11), params(11) },
		{ +8.461120666261989527e+02, -2.316233553732484324e+03, -1.548598847842363284e+02, params(2), params(2), params(2), params(12), params(12), params(12) },
		{ -4.811587547413210473e+02, +1.137251900271349996e+03, +8.982077975355166188e+01, params(3), params(3), params(3), params(13), params(13), params(13) },
		{ +9.730123682014752262e+01, -2.103194002435872108e+02, -1.924841893040710161e+01, params(4), params(4), params(4), params(14), params(14), params(14) }
	};
	const double c[5][9] =
	{
		{ +5.931197549458080402e+02, +1.643683543334689148e+03, +1.023039067435921652e+02, params(5), params(5), params(5), params(15), params(15), params(15) },
		{ -9.031718380783376006e+02, -2.755345192248678813e+03, -1.479786692329339246e+02, params(6), params(6), params(6), params(16), params(16), params(16) },
		{ +5.064178163837452189e+02, +1.699119802335634859e+03, +1.137617868316174281e+02, params(7), params(7), params(7), params(17), params(17), params(17) },
		{ -1.252029107059390185e+02, -4.567967781676988466e+02, -3.773474157010790009e+01, params(8), params(8), params(8), params(18), params(18), params(18) },
		{ +1.152715865282898022e+01, +4.530066759316437697e+01, +4.459442449946313225e+00, params(9), params(9), params(9), params(19), params(19), params(19) }
	};
#endif
#elif MIXTURE_COMPS == 3
#if PHASE == 0
	const double a[5][15] =
	{
		{ -2.112335199397250918e+01, -2.122296384713962780e+01, -2.829967280774834748e+01, -1.352011627680349548e+01, -2.708112392650563649e+01, -5.410171351598648215e+01, -5.750966489438579288e+01, +1.821674462526779337e+01, -1.912413200624013543e-01, params(0), params(10), params(20), params(30), params(40), params(50) },
		{ +1.046396618389127582e+02, +1.059785121920906477e+02, +1.260472794252481208e+02, +9.588792545080136165e+01, +1.502632324922821567e+02, +3.089503027350954767e+02, +4.614221862684092912e+02, -5.518357686292700492e+01, +4.219596253684290588e+01, params(1), params(11), params(21), params(31), params(41), params(51) },
		{ -1.599224337848212656e+02, -1.819807981679254567e+02, -2.084168293425671550e+02, -3.039088518876825447e+02, -3.210639416351861541e+02, -6.679739881442982323e+02, -1.048326398761897735e+03, -7.064422455653674149e+01, -1.981731578496536201e+02, params(2), params(12), params(22), params(32), params(42), params(52) },
		{ +8.664634611819901977e+01, +1.237434617839810613e+02, +1.458238757695254151e+02, +4.482211928238783116e+02, +2.926491445781529137e+02, +6.287594314476360751e+02, +9.508068391983825904e+02, +2.499209330540915630e+02, +3.180416880726381237e+02, params(3), params(13), params(23), params(33), params(43), params(53) },
		{ -1.542022369101818136e+01, -2.739369045135615011e+01, -3.585723434866019232e+01, -2.226447101375488558e+02, -9.399282089443353527e+01, -2.154121179016020164e+02, -2.921302051446056680e+02, -1.157228284691039022e+02, -1.276798359680327053e+02, params(4), params(14), params(24), params(34), params(44), params(54) }
	};
	const double c[5][15] =
	{
		{ +1.014050096628394959e-01, -2.542739287223894640e-01, -1.717154048277529377e-01, -1.630875916328565767e-01, -7.345210802360489788e-02, +3.165527629257279818e-01, +6.202562887289900795e-01, -3.198398128458649348e-01, -1.500246470959086809e-01, params(5), params(15), params(25), params(35), params(45), params(55) },
		{ +4.503818080797233847e+01, +9.355105225779826128e+01, +5.732789284514770856e+01, +1.590917797857085070e+01, +6.292141100047614088e+01, -2.657688916617167152e+01, -5.932697954210343028e+01, -2.569406939112417732e+01, -4.721471343755474948e+01, params(6), params(16), params(26), params(36), params(46), params(56) },
		{ -1.150004970895609375e+02, -6.855041029558282162e+01, +1.810478643057546151e+02, -2.226709812899811425e+02, +5.093252661266127461e+02, +5.068751855817992578e+02, +5.203578475452821976e+02, -3.156317929188516302e+01, +2.095564098298486044e+02, params(7), params(17), params(27), params(37), params(47), params(57) },
		{ +1.655638213007880211e+02, +1.885677302674298232e+02, -2.342503542711407931e+02, +4.173000559457457257e+02, -2.987231288348764906e+02, -7.949791840558518743e+02, -1.071729433060551173e+03, +1.983480371303739958e+02, -3.610920656991301030e+02, params(8), params(18), params(28), params(38), params(48), params(58) },
		{ -9.416721557588948599e+01, -1.781190705369886587e+02, +1.290861652223049703e+02, -2.578657035202964494e+02, +1.437207329731800769e+02, +5.850478395635790321e+02, +6.242504207285714983e+02, -1.297112146068885750e+02, +2.298531114884658848e+02, params(9), params(19), params(29), params(39), params(49), params(59) }
	};
#elif PHASE == 1
	const double a[5][15] =
	{
		{ +1.703440521331973798e+02, -7.186474267171755628e+02, -5.206671854231613139e+01, -3.103323453626480841e+02, +6.043124919392782601e+01, +3.406791988387100218e+02, -1.359673628432657040e+02, +3.121988320719976286e+02, -1.996420707685886953e+02, params(0), params(10), params(20), params(30), params(40), params(50) },
		{ -6.318017110160004677e+02, +2.107224065718693055e+03, +1.132924212617995181e+02, +9.073003904982375616e+02, -2.050573579115350640e+02, -4.755187023387419742e+01, -6.113309751097070688e+01, -1.896039752186011071e+02, -3.104379529337246879e+01, params(1), params(11), params(21), params(31), params(41), params(51) },
		{ +8.461120666261989527e+02, -2.316233553732484324e+03, -1.548598847842363284e+02, -1.154955641251076941e+03, +2.819804025889628178e+02, +4.550111021248309839e+01, -1.293636124863703287e+02, +9.126702913284695740e+01, +7.555832629246710042e+01, params(2), params(12), params(22), params(32), params(42), params(52) },
		{ -4.811587547413210473e+02, +1.137251900271349996e+03, +8.982077975355166188e+01, +7.194894680227357640e+02, -1.751683097600605947e+02, -2.037703812785874291e+01, +1.353795147969576362e+02, -4.261760061909373576e+01, -4.795822989395575320e+01, params(3), params(13), params(23), params(33), params(43), params(53) },
		{ +9.730123682014752262e+01, -2.103194002435872108e+02, -1.924841893040710161e+01, -1.635591092550701831e+02, +4.401776152182344504e+01, +3.655155873426282120e+00, -3.861457149788790133e+01, +9.106010908231182199e+00, +1.052458807726167045e+01, params(4), params(14), params(24), params(34), params(44), params(54) }
	};
	const double c[5][15] =
	{
		{ +5.931197549458080402e+02, +1.643683543334689148e+03, +1.023039067435921652e+02, -7.978805762709610008e+02, +2.014211094503205004e+02, +3.491231562088775036e+02, -6.519994721812227567e+01, +1.371594210323191305e+02, +1.312847294811719792e+02, params(5), params(15), params(25), params(35), params(45), params(55) },
		{ -9.031718380783376006e+02, -2.755345192248678813e+03, -1.479786692329339246e+02, +1.272803665113535544e+03, -3.502334069211859742e+02, -6.826330200127645753e+01, +1.649538341784401609e+02, -2.504169045693781186e+02, -1.348937232630663061e+02, params(6), params(16), params(26), params(36), params(46), params(56) },
		{ +5.064178163837452189e+02, +1.699119802335634859e+03, +1.137617868316174281e+02, -7.555187294268293954e+02, +5.793141758556252086e+01, +4.210906634350019573e+01, -1.215546966446330401e+02, +1.971529251641660494e+02, +9.695639668752370710e+01, params(7), params(17), params(27), params(37), params(47), params(57) },
		{ -1.252029107059390185e+02, -4.567967781676988466e+02, -3.773474157010790009e+01, +1.990581173266097892e+02, +5.249907025382743342e+01, -1.076244548421472835e+01, +4.110313072880704510e+01, -7.007205372707907998e+01, -3.112983656023824963e+01, params(8), params(18), params(28), params(38), params(48), params(58) },
		{ +1.152715865282898022e+01, +4.530066759316437697e+01, +4.459442449946313225e+00, -1.957555626913838509e+01, -1.328795068254610179e+01, +9.318311315521377036e-01, -5.520227643470938084e+00, +9.744869188592794274e+00, +3.853939340152781501e+00, params(9), params(19), params(29), params(39), params(49), params(59) }
	};



#endif
#endif


	//std::cout << input << std::endl;
#if 1
	const double temp[2] = { input(ed::T1), input(ed::T2) };
	const double pres[2] = { input(ed::P1), input(ed::P2) };
	const double dens[2] = { input(ed::d1_rival), input(ed::d2_rival) };
	const double comp[3] = { input(ed::zN2), input(ed::zAr), input(ed::zO2) };
	const double DH = input(ed::DH_rival);


	const double temp_c_mix =
		+temp_c[0] * comp[0]
		+ temp_c[1] * comp[1]
		+ temp_c[2] * comp[2];

	const double dens_c_mix =
		+dens_c[0] * comp[0]
		+ dens_c[1] * comp[1]
		+ dens_c[2] * comp[2];

	double tau_print[2] = { 0., 0. };
	double delta_print[2] = { 0., 0. };

	for (int k = 0; k < 2; k++)
	{

		const double tau = temp_c_mix / temp[k];
		tau_print[k] = tau;

		const double delta = dens[k] / dens_c_mix;
		delta_print[k] = delta;

		const double tau2 = tau * tau;
		const double tau3 = tau * tau2;
		const double tau4 = tau * tau3;
		const double tau5 = tau * tau4;

		const double delta2 = delta * delta;
		const double delta3 = delta * delta2;
		const double delta4 = delta * delta3;
		const double delta5 = delta * delta4;

		{ // MONO CORRECTION
			for (int i = 0; i < 3; i++)
			{
				DHr[k] += (comp[i])
					*
					(a[0][i]
						+ tau * a[1][i]
						+ tau2 * a[2][i]
						+ tau3 * a[3][i]
						+ tau4 * a[4][i]
						)
					*
					(c[0][i]
						+ delta * c[1][i]
						+ delta2 * c[2][i]
						+ delta3 * c[3][i]
						+ delta4 * c[4][i]
						);
			}
		}

#if MIXTURE_COMPS > 1
		{ // BINARY CORRECTION
			int i_[6] = { 0, 0, 1, 1, 2, 2 };
			int j_[6] = { 1, 2, 2, 0, 0, 1 };

			for (int n = 0; n < 6; n++)
			{
				DHr[k] += (comp[i_[n]] * comp[i_[n]] * comp[j_[n]])
					*
					(a[0][n + 3]
						+ tau * a[1][n + 3]
						+ tau2 * a[2][n + 3]
						+ tau3 * a[3][n + 3]
						+ tau4 * a[4][n + 3]
						)
					*
					(c[0][n + 3]
						+ delta * c[1][n + 3]
						+ delta2 * c[2][n + 3]
						+ delta3 * c[3][n + 3]
						+ delta4 * c[4][n + 3]
						);
			}
		}
#endif

#if MIXTURE_COMPS > 2
		{ // TERNARY CORRECTION
			int i_[6] = { 0, 0, 1, 1, 2, 2 };
			int j_[6] = { 1, 2, 0, 2, 0, 1 };
			int k_[6] = { 2, 1, 2, 0, 1, 0 };

			for (int n = 0; n < 6; n++)
			{
				DHr[k] += (comp[i_[n]] * comp[i_[n]] * comp[i_[n]] * comp[j_[n]] * comp[j_[n]] * comp[k_[n]])
					*
					(a[0][n + 3 + 6]
						+ tau * a[1][n + 3 + 6]
						+ tau2 * a[2][n + 3 + 6]
						+ tau3 * a[3][n + 3 + 6]
						+ tau4 * a[4][n + 3 + 6]
						)
					*
					(c[0][n + 3 + 6]
						+ delta * c[1][n + 3 + 6]
						+ delta2 * c[2][n + 3 + 6]
						+ delta3 * c[3][n + 3 + 6]
						+ delta4 * c[4][n + 3 + 6]
						);
			}
		}
#endif
	}

#if 0
	std::cout <<
		"tau1" << "\t" <<
		"tau2" << "\t" <<
		"delta1" << "\t" <<
		"delta2" << "\t" <<
		"DHr1" << "\t" <<
		"DHr2" <<
		std::endl;

	std::cout <<
		tau_print[0] << "\t" <<
		tau_print[1] << "\t" <<
		delta_print[0] << "\t" <<
		delta_print[1] << "\t" <<
		DHr[0] << "\t" <<
		DHr[1] <<
		std::endl;
#endif
#if 0
	static long int iter_count = 0;
	if (iter_count % (dataset.size() * 48) == 0)
	{
		printf("\n--------------------------------------\n");
		printf("ITER: %d\n", iter_count);
		for (int k = 0; k < 2; k++)
		{
			for (int i = 0; i < 4; i++)
			{
				for (int j = 0; j < MIXTURE_MOLTIPLICATOR; j++)
				{
					double var = 0;
					if (k == 0)
						var = a[i][j + 3 + 6];
					else
						var = c[i][j + 3 + 6];


					if (var > 0)
						printf("+%.18e\t", var);
					else
						printf("%.18e\t", var);
				}
				printf("\n");
			}
		}
		printf("--------------------------------------\n");
	}
	iter_count++;
#endif

	return DH + DHr[1] - DHr[0];
#else
	return 0;
#endif
}
